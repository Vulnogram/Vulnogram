//- Copyright (c) 2020 Chandan B N. All rights reserved.

extends layout
  
block append head
    if !min
        link(rel='stylesheet', href= '/users/list/css')
    link(href=conf.basedir + "css/tagify.css",rel="stylesheet",type="text/css")
    link(rel='stylesheet', href=conf.basedir + 'css/simplehtml.css')

block prepend topHeaderLeft
    if !min
        a.rbtn.vgi-back(href=(confOpts[schemaName].conf.uri? confOpts[schemaName].conf.uri : '/' + schemaName + '/' ), title=confOpts[schemaName].conf.title)

block append topHeaderLeft
    if !confOpts[schemaName].conf.readonly
        block openButton
            input#importJSON.hid(type="file",accept="application/json",onchange="loadFile(event,this);")
            button.fbn.vgi-folder(type="file",onclick='importFile(event, this);')
    
block prepend outputButtons
    if !confOpts[schemaName].conf.readonly
        if !min
            button.fbn.vgi-put(id="save1") Save    
        a.fbn.vgi-download(title="Download JSON" type="button",oncontextmenu='downloadFile(event, this);',onclick='downloadFile(event, this);',value="Download")

block append sidebarNav
    if !(opts && opts.conf && opts.conf.disableDrafts)
        details#draftsGroup.sidebar-expandable.bort
            summary.lbl.vgi-edit Drafts
                span.pad.tgrey#draftsCount
            #draftsEmpty.lbl No drafts yet.
            #draftsList.flx

block scripts
    if opts
        script
            | var iconMap = 
            if opts.icons
                | !{JSON.stringify(opts.icons)}
            else
                | {};
        if opts.script
            script !{opts.script}
        if opts.render
            - var compileScript = pugLib.compileFileClient('views/'+opts.render +'.pug', {name: "pugRender",basedir: 'views',compileDebug: false,inlineRuntimeFunctions: true})
            script !{compileScript}
        if opts.script && typeof opts.script === 'array'
            script
                each i,v in opts.script
                    | #{v} = !{opts.script[v].toString()};
        if opts.validators
            script
                | var custom_validators = [!{opts.validators.toString()}];
        if opts.errorFilter
            script
                | var errorFilter = !{opts.errorFilter.toString()};
    if !min
        script var csrfToken = "#{csrfToken}";
        if opts && opts.conf && !opts.conf.readonly
            - var compileScript = pugLib.compileFileClient('views/subcontent.pug', {name: "subdocRender",basedir: 'views',compileDebug: false,inlineRuntimeFunctions: true})
            script !{compileScript}

block content
    div#mainTabGroup
        span.lbl &nbsp;
        div#statusArea.nobr
            span.lbl#infoMsg
                if doc && doc.updatedAt
                    ='Updated ' + textUtil.formatFriendlyDate(doc.updatedAt) + ' by ' + doc.author
            if !min && conf.realtime && conf.realtime.enabled
                span.lbl#realtimeStatus Offline
                span.lbl#realtimeViewers
        block editorTab
            input.tab(name='tabs', type='radio', id='editorTab', value="1",checked)
            label.lbl#editorLabel(for='editorTab')
                span.flx
                    block editorLabel
                        | Editor
                    details.popup#errPop
                        summary.sml.hid#errCount
                        div.wht.pop.pad.bor.rnd.shd#errList
            .fil.bort.tpad
                block editorArea
                    iframe.hid(name="x",src="about:blank")
                    form.editor(target="x",action="",id="docEditor")
                    if !min
                        a#remove.gap.flr.fbn.vgi-del.tred Delete this entry from local Vulnogram database
        block sourceTab
            input.tab(name='tabs', type='radio', id='sourceTab', value="2")
            label.lbl(for='sourceTab')
                block sourceLabel 
                    | Source
            .fil.bort.pad
                div(id="output",rows="40",cols="100%")
                    p

        block customtabs

        if !min
            input.tab(name='tabs', type='radio', id='changesTab', value="6")
            label.lbl(for='changesTab') Changes
            .wht.fil.bort
                div#unSavedChanges
                div#changelog
    
    block initGlobals
        script
            if conf.publicDefectURL
                | var defectURL = "!{conf.publicDefectURL}";
            | var idpath = "#{idpath}";
            | var allowAjax = #{allowAjax === true};
            | var soloMode = #{min === true};
            | var schemaName = "#{schemaName}";
            | var draftsEnabled = #{!(opts && opts.conf && opts.conf.disableDrafts)};
            | var postUrl = "#{postUrl?postUrl:''}";
            | var csrfToken = "#{csrfToken}";
            | var ajaxBase  = "#{conf.basedir}";
            if !min && conf.realtime && conf.realtime.enabled
                | var realtimeEnabled = true;
                - var rtConf = JSON.stringify(conf.realtime).replace(/\u2028/g, '\\u2028').replace(/\u2029/g, '\\u2029').replace(/</g, '\\u003C').replace(/>/g, '\\u003E').replace(/\//g, '\\u002F');
                | var realtimeConfig = !{rtConf};
            else
                | var realtimeEnabled = false;
                | var realtimeConfig = {};
            if doc && doc.body
                | var initJSON=!{JSON.stringify(doc.body).replace(/\u2028/g, '\\u2028').replace(/\u2029/g, '\\u2029').replace(/</g, '\\u003C').replace(/>/g, '\\u003E').replace(/\//g, '\\u002F')};
            else
                | var initJSON = undefined;
            if min
                | var docSchema=!{JSON.stringify(opts && opts.schema ? opts.schema : '{}').replace(/\u2028/g, '\\u2028').replace(/\u2029/g, '\\u2029').replace(/</g, '\\u003C').replace(/>/g, '\\u003E').replace(/\//g, '\\u002F')};


    if !min && opts && opts.schema
        script(src=conf.basedir + schemaName + '/schema.js')
    if conf.ajv && conf.ajvHash
      script(src=conf.ajv,integrity=conf.ajvHash,crossorigin="anonymous")
    script(src=conf.jsoneditor,integrity=conf.jsoneditorHash,crossorigin="anonymous")
    script(src=conf.ace,integrity=conf.aceHash,crossorigin="anonymous")
    if !min && conf.realtime && conf.realtime.enabled
        script(src="/socket.io/socket.io.js")
        script(src=conf.basedir + "js/json-patch-extended.min.js")
    script(src=conf.basedir + 'js/vg-editor.js')
    script(src=conf.basedir + 'js/tablesort.min.js')

    block loadEditor
        - var msg = doc && doc.updatedAt ? 'Updated ' + textUtil.formatFriendlyDate(doc.updatedAt) + ' by ' + doc.author : '';
        script loadJSON(initJSON,"#{doc_id}",!{JSON.stringify(msg)});

    if doc && doc.body
        script getChanges("#{doc_id}");
    +alertDialog

block subcontent
    if !min
        include subcontent
        - var id = doc_id;
        if doc && opts && opts.conf && opts.conf.files
            - var files = [];
            if doc && doc.files
                - files = doc.files;
            +files
        +commentBox
        if doc && Object.keys(doc).length > 0
            script
                | document.getElementById("commentTemplate").insertAdjacentElement('afterend', newCommentBox());
        #commentsBox
            - var username = user.username;
            - var docs = ucomments;//.sort(function(a, b) {return a.updatedAt < b.updatedAt;})
            #comments
                +comments

block logolink
    br
    a.vgi-logo(href="https://github.com/Vulnogram/Vulnogram") Vulnogram Project

mixin alertDialog
    dialog.bor.rnd.shd.pad2#alertDialog
      center
        form(onsubmit="event.preventDefault();return false;")
            h2.vgi-alert#alertMessage
            .gap#smallAlert  
            center.gap
                input#alertOk.btn.sfe(type="reset" onclick="document.getElementById('alertDialog').close();" value="OK")
                input#alertCancel.btn.red.alert-cancel(type="reset" onclick="document.getElementById('alertDialog').close();" value="Cancel")
